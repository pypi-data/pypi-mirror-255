#!/usr/bin/env python

import os
import logging
import argparse
import re
#import ms_teams_json
#import message_handler
import azure_key_vault_report
import az_cmd


vaults = """robim-kv-prod"""

#vaults = """kv-safwrap-dev
#kv-safwrap-prod
#kv-safwrap-qa
#kv-safwrap-shared
#kv-thelma-backup
#kv-thelma-dev
#kv-thelma-docs
#kv-thelma-prod
#kv-thelma-qa
#kv-thelma-shared
#kv-thelma-test
#kv-thelma-testing
#"""


record_types = ["secret"]

# Runs all the az key vaults commands and add the results to the 'az_results' list
az_results = []
for vault in vaults.splitlines():
    az_results += az_cmd.az_cmd(vault, record_types, path="/opt/homebrew/bin")

# The report is generated by using the pip package ops-py-azure-key-vault-report
# If argument 'include_no_expiration' is not provided,
# the variable 'ignore_no_expiration' is then set to True
kv_report = azure_key_vault_report.AzureKeyVaultReport(az_results)
kv_report.parse_results()
kv_report.generate_report(include_all=True)
report = kv_report.get_report()
for row in report:
    print(row)


#html = kv_report.get_html()
#print(html)

'''
if "CertificateRenewal" in o.get("name") and "expires" in k:
    value = "2024-01-17"

if "ClientSecret" in o.get("name") and "expires" in k:
    value = "2024-01-10"
'''




res = [{'vault_name': 'robim-kv-prod', 'record_type': 'certificate', 'out': [{'attributes': {'created': '2023-11-02T13:33:30+00:00', 'enabled': True, 'expires': '2024-11-01T23:59:59+00:00', 'notBefore': '2023-11-02T00:00:00+00:00', 'recoveryLevel': None, 'updated': '2023-11-02T13:33:30+00:00'}, 'id': 'https://robim-kv-prod.vault.azure.net/certificates/robim-beta', 'name': 'robim-beta', 'subject': '', 'tags': {}, 'x509Thumbprint': 'awhUALiOtIp1G5Om6vBqwkvD8O8=', 'x509ThumbprintHex': '6B085400B88EB48A751B93A6EAF06AC24BC3F0EF'}, {'attributes': {'created': '2023-05-12T11:31:56+00:00', 'enabled': True, 'expires': '2024-05-14T23:59:59+00:00', 'notBefore': '2023-05-12T00:00:00+00:00', 'recoveryLevel': None, 'updated': '2023-05-12T11:31:56+00:00'}, 'id': 'https://robim-kv-prod.vault.azure.net/certificates/robim-equinor-com', 'name': 'robim-equinor-com', 'subject': '', 'tags': {}, 'x509Thumbprint': 'S9Gn0+h4IJXP51MVbw/5ATF1FbA=', 'x509ThumbprintHex': '4BD1A7D3E8782095CFE753156F0FF901317515B0'}, {'attributes': {'created': '2023-10-13T08:36:40+00:00', 'enabled': True, 'expires': '2024-10-13T08:36:40+00:00', 'notBefore': '2023-10-13T08:26:40+00:00', 'recoveryLevel': None, 'updated': '2023-10-13T08:36:40+00:00'}, 'id': 'https://robim-kv-prod.vault.azure.net/certificates/robim-old-equinor-com', 'name': 'robim-old-equinor-com', 'subject': '', 'tags': {}, 'x509Thumbprint': 'MDdQL9gar1FzPaJTPLRnJAGIcz8=', 'x509ThumbprintHex': '3037502FD81AAF51733DA2533CB467240188733F'}]}, {'vault_name': 'robim-kv-prod', 'record_type': 'secret', 'out': [{'attributes': {'created': '2023-11-23T13:16:25+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-23T13:16:25+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/AccessItUri', 'managed': None, 'name': 'AccessItUri', 'tags': {}}, {'attributes': {'created': '2019-08-21T13:14:10+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2019-08-21T13:14:10+00:00'}, 'contentType': 'Password', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/api-management-key', 'managed': None, 'name': 'api-management-key', 'tags': None}, {'attributes': {'created': '2023-08-21T10:22:39+00:00', 'enabled': True, 'expires': '2024-08-21T08:28:11+00:00', 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-08-21T10:22:39+00:00'}, 'contentType': 'client secret', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/cams-api-client-secret', 'managed': None, 'name': 'cams-api-client-secret', 'tags': {}}, {'attributes': {'created': '2022-09-20T09:11:12+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2022-09-20T09:11:12+00:00'}, 'contentType': 'subscription key', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/cams-api-subscription-key', 'managed': None, 'name': 'cams-api-subscription-key', 'tags': {}}, {'attributes': {'created': '2023-08-21T10:23:36+00:00', 'enabled': True, 'expires': '2024-08-21T08:28:11+00:00', 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-08-21T10:23:36+00:00'}, 'contentType': 'client secret', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/cams-roles-api-client-secret', 'managed': None, 'name': 'cams-roles-api-client-secret', 'tags': {}}, {'attributes': {'created': '2023-02-13T09:23:58+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-02-13T09:23:58+00:00'}, 'contentType': 'Subscription key', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/cams-roles-api-subscription-key', 'managed': None, 'name': 'cams-roles-api-subscription-key', 'tags': {}}, {'attributes': {'created': '2023-11-07T13:25:50+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-07T13:25:50+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/DispensationBaseUri', 'managed': None, 'name': 'DispensationBaseUri', 'tags': {}}, {'attributes': {'created': '2023-10-10T08:52:05+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-10-10T08:52:05+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/DocmapBaseUri', 'managed': None, 'name': 'DocmapBaseUri', 'tags': {}}, {'attributes': {'created': '2023-11-17T13:40:38+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-17T13:40:38+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/EchoMapsUri', 'managed': None, 'name': 'EchoMapsUri', 'tags': {}}, {'attributes': {'created': '2023-11-17T13:42:38+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-17T13:42:38+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/EchoUri', 'managed': None, 'name': 'EchoUri', 'tags': {}}, {'attributes': {'created': '2023-02-23T15:09:08+00:00', 'enabled': True, 'expires': '2024-02-22T15:07:47+00:00', 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-02-23T15:09:08+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/employeeapi-client-secret', 'managed': None, 'name': 'employeeapi-client-secret', 'tags': {}}, {'attributes': {'created': '2020-02-24T17:20:21+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2020-02-24T17:20:21+00:00'}, 'contentType': 'Password', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/employeeapi-subscription-key', 'managed': None, 'name': 'employeeapi-subscription-key', 'tags': None}, {'attributes': {'created': '2023-04-19T08:22:51+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-04-19T08:22:51+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/enterprise-subscription-key', 'managed': None, 'name': 'enterprise-subscription-key', 'tags': {}}, {'attributes': {'created': '2023-11-07T13:16:42+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-07T13:16:42+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/GisPlatformQueryBaseUri', 'managed': None, 'name': 'GisPlatformQueryBaseUri', 'tags': {}}, {'attributes': {'created': '2023-11-07T13:17:02+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-07T13:17:02+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/GisQueryBaseUri', 'managed': None, 'name': 'GisQueryBaseUri', 'tags': {}}, {'attributes': {'created': '2019-08-21T13:18:19+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2019-08-21T13:18:19+00:00'}, 'contentType': 'Password', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/influxdb-password', 'managed': None, 'name': 'influxdb-password', 'tags': None}, {'attributes': {'created': '2019-08-21T13:19:04+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2019-08-21T13:19:04+00:00'}, 'contentType': 'Username', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/influxdb-username', 'managed': None, 'name': 'influxdb-username', 'tags': None}, {'attributes': {'created': '2023-11-07T13:23:06+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-07T13:23:06+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/IwitBaseUri', 'managed': None, 'name': 'IwitBaseUri', 'tags': {}}, {'attributes': {'created': '2019-08-21T13:20:04+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2019-08-21T13:20:04+00:00'}, 'contentType': 'Password', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/ksat-password', 'managed': None, 'name': 'ksat-password', 'tags': None}, {'attributes': {'created': '2019-08-21T13:21:58+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2019-08-21T13:21:58+00:00'}, 'contentType': 'Username', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/ksat-username', 'managed': None, 'name': 'ksat-username', 'tags': None}, {'attributes': {'created': '2023-11-07T13:28:26+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-07T13:28:26+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/MaintenanceNotificationBaseUrl', 'managed': None, 'name': 'MaintenanceNotificationBaseUrl', 'tags': {}}, {'attributes': {'created': '2023-11-07T13:28:48+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-07T13:28:48+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/MaintenanceWorkOrderBaseUrl', 'managed': None, 'name': 'MaintenanceWorkOrderBaseUrl', 'tags': {}}, {'attributes': {'created': '2023-11-17T13:43:25+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-17T13:43:25+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/OptDashboardUri', 'managed': None, 'name': 'OptDashboardUri', 'tags': {}}, {'attributes': {'created': '2023-02-23T15:11:25+00:00', 'enabled': True, 'expires': '2024-02-22T15:09:15+00:00', 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-02-23T15:11:25+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/organizationapi-client-secret', 'managed': None, 'name': 'organizationapi-client-secret', 'tags': {}}, {'attributes': {'created': '2020-02-24T17:19:36+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2020-02-24T17:19:36+00:00'}, 'contentType': 'Password', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/organizationapi-subscription-key', 'managed': None, 'name': 'organizationapi-subscription-key', 'tags': None}, {'attributes': {'created': '2023-07-04T07:46:47+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-07-04T07:46:47+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/robim-client-secret', 'managed': None, 'name': 'robim-client-secret', 'tags': {}}, {'attributes': {'created': '2022-11-14T13:30:21+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2022-11-14T13:30:21+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/robim-cs', 'managed': None, 'name': 'robim-cs', 'tags': {}}, {'attributes': {'created': '2021-11-18T13:31:03+00:00', 'enabled': True, 'expires': '2022-11-18T13:28:58+00:00', 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2021-11-18T13:31:03+00:00'}, 'contentType': 'Password', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/robim-db-password', 'managed': None, 'name': 'robim-db-password', 'tags': {}}, {'attributes': {'created': '2021-11-18T13:31:33+00:00', 'enabled': True, 'expires': '2022-11-18T13:28:58+00:00', 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2021-11-18T13:31:33+00:00'}, 'contentType': 'Username', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/robim-db-username', 'managed': None, 'name': 'robim-db-username', 'tags': {}}, {'attributes': {'created': '2024-02-06T11:53:43+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2024-02-06T11:53:43+00:00'}, 'contentType': '', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/RobimFrontendUri', 'managed': None, 'name': 'RobimFrontendUri', 'tags': {}}, {'attributes': {'created': '2019-08-21T16:35:48+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2019-08-21T16:35:48+00:00'}, 'contentType': 'Connectionstring', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/robimweb-as-cs', 'managed': None, 'name': 'robimweb-as-cs', 'tags': None}, {'attributes': {'created': '2023-04-26T08:43:30+00:00', 'enabled': True, 'expires': '2024-04-25T08:28:57+00:00', 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-04-26T08:43:30+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/smda-robim-client-secret', 'managed': None, 'name': 'smda-robim-client-secret', 'tags': {}}, {'attributes': {'created': '2021-05-03T11:19:17+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2021-05-03T11:19:17+00:00'}, 'contentType': 'Password', 'id': 'https://robim-kv-prod.vault.azure.net/secrets/smda-subscription-key', 'managed': None, 'name': 'smda-subscription-key', 'tags': None}, {'attributes': {'created': '2023-11-07T13:19:47+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-07T13:19:47+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/StidBaseUri', 'managed': None, 'name': 'StidBaseUri', 'tags': {}}, {'attributes': {'created': '2023-11-07T13:25:16+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-07T13:25:16+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/SynergiCaseBaseUrl', 'managed': None, 'name': 'SynergiCaseBaseUrl', 'tags': {}}, {'attributes': {'created': '2023-11-23T13:15:17+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-23T13:15:17+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/SynergiRobimHelpdeskUri', 'managed': None, 'name': 'SynergiRobimHelpdeskUri', 'tags': {}}, {'attributes': {'created': '2023-09-05T09:11:08+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-09-05T09:11:08+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/timeseriesapi-robim-client-secret', 'managed': None, 'name': 'timeseriesapi-robim-client-secret', 'tags': {}}, {'attributes': {'created': '2023-11-07T13:24:48+00:00', 'enabled': True, 'expires': None, 'notBefore': None, 'recoverableDays': 90, 'recoveryLevel': 'Recoverable', 'updated': '2023-11-07T13:24:48+00:00'}, 'contentType': None, 'id': 'https://robim-kv-prod.vault.azure.net/secrets/WellcomBaseUri', 'managed': None, 'name': 'WellcomBaseUri', 'tags': {}}]}, {'vault_name': 'robim-kv-prod', 'record_type': 'key', 'out': []}]

kv_report = AzureKeyVaultReport(res)
kv_report.parse_results()
kv_report.add_summary()
kv_report.add_report()
report = kv_report.get_markdown_report()
print(report)
